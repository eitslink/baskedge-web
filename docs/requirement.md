# 要件定義書｜バスケットボール特化スポーツ運営WEBアプリ

本書は SportsPress Pro（機能群）を参考に、**バスケットボール競技に特化**した運営プラットフォームを **Next.js App Router + TailwindCSS + shadcn/ui + Supabase** で実装するための要件定義である。先行して **WEBアプリ** を公開し、その後 **プレイヤー等がログインできるモバイルアプリ**（同一バックエンド）を段階的にリリースする前提とする。

---

## 1. 目的とゴール

* リーグ／クラブ運営に必要な **試合・選手・チーム・会場・順位・統計** の登録・集計・公開を一元化。
* **試合公開=集計トリガー** を基本とし、順位表・選手ランキング等を自動更新。
* バスケ固有の **タイムライン（PBP）** と **統計式（Equation Builder）** を備え、将来的な高度指標・可視化（ショットチャート等）へ拡張可能。
* マルチテナント（複数リーグ／クラブ）運営と **Team Access（チーム単位のRLS権限）** を実現。

KPI 例：

* 1ヶ月以内に **公開試合ページ 300件**、**ユニーク閲覧 10,000**、**スコア登録平均遅延 < 10分**。

---

## 2. 想定ユーザー／ペルソナ

* **League Manager（運営本部）**：全体設定・大会設計・承認。
* **Team Manager（各チーム）**：選手登録・試合のスコア入力・レポート確認・出欠承認。
* **Coach/Staff**：ロスター・出場時間・対戦準備。
* **Referee（審判）**：アサイン確認、当日出欠、試合後レポート／反則・テクニカル記録、署名。
* **Fans / Public**：試合日程・結果・順位・個人成績の閲覧。
* **Player**（モバイル以降）：自分の成績・出場時間・通知の受領。

---

## 3. スコープ（MVP → 拡張）

### 3.1 MVP（WEB リリース）

* **イベント（試合）管理**：日程作成、会場割当、ロスター（スターター/ベンチ）、結果入力。
* **出場可否申請（ロスター出欠）**：チーム代表者が試合ごとに対象選手へ出欠収集（参加／欠席／未定、理由、締切、承認フロー）。承認後ロック（例：試合開始24時間前）。
* **自動集計**：チーム戦績（W/L、得点、失点、勝率）、選手ボックススコア累計。
* **順位表（League Tables）**：式定義に基づく並び替え・自動更新。
* **選手リスト／ランキング（Player Lists）**：PTS、REB、AST、FG%、3P%、FT%、EFF 等。
* **生涯記録（Career Stats v1）**：大会・シーズン横断の個人累計/平均を集計する公開ビュー。
* **タイムライン（Timelines）**：得点、アシスト、リバウンド、ファウル、TO、交代などのPBP登録・表示。
* **スコアボード（Scoreboard）**：同日複数試合のスコア横並び表示。
* **トーナメント（Tournaments）**：ノックアウト・ブラケット表示、結果反映。
* **スポンサー/広告（Sponsors & Ads）**：ロゴ掲載、クリック/表示回数の記録、アフィリエイトリンクのUTM付与と計測、配置制御。
* **チーム募集・待機列**：新規チームの参加申請、枠管理、キャンセル待ち繰上げ、通知。
* **スタッフ名鑑（Staff Directory）**：役職・連絡先。
* **審判管理（アサイン）**：試合ごとの審判割当、受諾/辞退、当日出欠、試合後レポート提出。
* **チームアクセス（Team Access）**：RLSでチーム所属ユーザーのみ編集可。
* **ブランド設定**：チームカラー、ロゴ、リーグ全体テーマ（ライト/ダーク）。
* **リーグメニュー**：大会・シーズン横断ナビゲーション。
* **公開サイト機能**：試合一覧、カレンダー、チーム/選手ページ、会場地図表示。
* **CSVインポート**：チーム・選手・試合の一括投入（管理者限定）。

### 3.2 早期拡張（WEB）

* **Equation Builder**：式のGUI定義（加重平均、率、条件式）。
* **ショットチャート**：座標入力 → eFG%/TS% の可視化。
* **高度指標**：ORTG/DRTG、USG%、ラインナップ別 ±、ポゼッション推定。
* **複製機能（Duplicator）**：イベント雛形のコピー。
* **SNS埋め込み**：X(Twitter) タイムライン、OGP自動生成。

### 3.3 モバイル（フェーズ2）

* **ログイン（選手/スタッフ/審判）**、自分の成績・出場時間、試合通知（PUSH）。
* **現場入力**：PBP・スタッツのモバイルUI、**オフライン対応**→再接続で同期。
* **出欠回答**：試合ごとの参加/欠席のワンタップ申請（代表者承認フローと連動）。
* **メッセージング**：チーム連絡、メディア共有（クラウドストレージ）。

---

## 4. システム構成／技術スタック

* **フロント**：Next.js 14+（App Router, RSC/SSR/ISR併用）, TypeScript, TailwindCSS, **shadcn/ui**。
* **認証/DB/Realtime**：**Supabase**（PostgreSQL, Auth, Storage, Realtime, Edge Functions, Cron）。
* **ホスティング**：**Cloudflare（WEB）**：Pages（Next.js）、Functions/Workers（エッジ処理・画像最適化・Turnstile検証）、CDNキャッシュ。
* **解析**：**Cloudflare Web Analytics** + Supabase Logs/Telemetry。
* **地図**：Leaflet or MapLibre（ベクタ地図） + OpenStreetMap。

### 4.1 レンダリング戦略

* **公開ページ**（試合、順位、ランキング）：ISR（60〜120秒）でキャッシュ、結果確定時は **タグ無効化**。Cloudflare CDN と協調し **Cache-Tag** 無効化。
* **ライブページ**：SSR/Edge Runtime + Supabase Realtime でスコア/タイムライン即時反映。

### 4.2 セキュリティ

* Supabase **RLS**（Row Level Security）で **organization\_id / team\_id** をキーに分離。
* 権限：`league_manager` / `team_manager` / `event_scorer` / `referee` / `player` / `viewer` などのロール。
* 監査：`audit_logs`（操作種別、対象、ユーザー、時刻）。
* Turnstile（Bot対策）、CSP、署名付きURL（Storage）。
* 秘匿情報：環境変数（Cloudflare Functions/Workers, Supabase Edge Functions）。

---

## 5. UI情報設計（SaaSアクセス制御を含む）

### 5.1 テナントとアクセス可視性

* **テナント（Organization）単位の分離**：代表管理者（League Manager）が作成した「大会・シーズン・ゲーム・チーム・選手・スポンサー」等は、そのテナントに属するユーザーのみ管理・閲覧（**内部ビュー**）。
* **公開ビュー**：試合結果・日程・順位・個人成績・スポンサー掲出は公開設定時に **一般公開URL** で誰でも閲覧可能。
* **スタッフ/当事者範囲**：Team Manager/Staff/Referee/Player は自チーム・自担当試合の範囲で編集/閲覧。別テナントや別大会の内部データはアクセス不可。

> 実装：Supabase RLS（organization\_id / team\_id / assignment）+ Cloudflare Cache-Tag による公開ページキャッシュ。

---

### 5.2 グローバルナビ（SaaS共通）

* **左サイドナビ**（ログイン時）：ダッシュボード／ゲーム／チーム／選手／スタッフ／審判／スポンサー／設定。
* **上部コンテキストバー**：Organization（固定） > 大会（League） > シーズン（Season）選択（`Select`×3）。
* **公開サイトヘッダー**：リーグメニュー、シーズン切替、検索（チーム・選手・会場）。

使用コンポーネント例：`NavigationMenu`, `Select`, `Breadcrumb`, `Avatar`, `Badge`, `Tabs`, `Table`, `Card`, `Dialog`, `Drawer`。

---

### 5.3 ゲームメニュー（一覧/詳細/入力）

**一覧（ゲームリスト）**

* フィルタ：大会、シーズン、ステータス（予約/ライブ/集計中/完了）、会場、対戦チーム。
* 表示列：

  * **ゲーム名**：`Aチーム vs Bチーム`
  * **日付/時間**
  * **チームスコア要約**：`60（A） / 40（B）`（勝者を強調表示）
  * **League（大会名）**、**Season（例：2025）**
  * **コート**（例：〇〇体育館Aコート）
  * **ステータス**（予約/集計中/完了 等）
* アクション：新規作成、CSVインポート、複製、詳細へ。

**詳細（ゲーム詳細/編集）**

* ヘッダー：ゲーム名、日時、会場、配信リンク（YouTube 埋め込み）、状態バッジ。
* **クォーター入力**：Q1〜Q4/OT のチーム得点、トータル自動集計。`Table` + 自動合計。
* **スコアシート入力**：スコアシート様式に沿った入力ボックス（FT/2P/3P/AST/REB/STL/BLK/TO/PF/出場時間）。
* **ファイル添付**：スコアシート写真（Storage）アップロード、サムネイル表示。
* **コメント/メッセージ**：試合運営用メモ、公開/非公開の切替。
* **公開操作**：ドラフト→ライブ→集計中→**完了/公開**（公開で一般ページ生成 & キャッシュ更新）。

**出欠（ロスター出場可否）**

* 代表者が対象選手に参加依頼（締切、理由）、選手/代理入力→承認→ロック（試合24h前など）
* ステータス：出席/欠席/未定、承認者、変更履歴。

---

### 5.4 チームメニュー

* **チーム登録**：チーム名、ロゴ、創設年、ホームタウン、カラー。
* **参加履歴**：大会/シーズンごとの参加状況をタイムライン表示。
* **スタッフ**：監督、コーチ等の紐づけ。
* **選手紐づけ**：在籍/移籍履歴、背番号。
* **記録**：過去順位表・戦績の一覧。

公開制御：チームページは公開ONで一般表示、スタッフ公開の可否を項目別に設定。

---

### 5.5 選手メニュー

* 入力項目：背番号、国籍、ポジション、身長、体重、利き手、顔写真。
* **経歴**：過去の所属チーム遍歴。
* **現所属**：現在のチーム・背番号。
* **個人記録**：試合別・シーズン別・**生涯記録**（累計/平均）。
* **重複防止**：運営者のみ新規作成（`persons` 親IDベース）、ファジー一致で候補提示しマージ可能。

公開制御：顔写真やプロフィールの公開/非公開を選択可能。

---

### 5.6 スタッフメニュー

* スタッフ登録（会長/副会長/会計など役割）、ログイン権限付与。
* 一般公開の可否を項目単位で設定。

---

### 5.7 審判メニュー

* 審判員登録（選手兼任可）。取得ライセンス、所属協会、経験年数。
* **アサイン管理**：試合割当、受諾/辞退、当日出欠登録。
* **試合後レポート**：反則/テクニカルの内訳、所見、署名。

---

### 5.8 スポンサー/広告

* スポンサー登録（大会/シーズン紐づけ、期間、掲載位置）。
* **広告エリア**：アフィリエイトURL（UTM）設定、表示/クリック計測、上限設定、開始/終了日。
* 公開ページへの自動掲出（ヘッダー/サイド/本文内スロット）。

---

### 5.9 募集/待機列

* 新規チーム募集フォーム（Turnstile、審査→承認/却下/待機）。
* 待機列管理：繰上げ発生時の通知（メール/Push）。

---

### 5.10 公開サイト（一般閲覧）

* ゲーム一覧・詳細、順位表、選手ランキング、チーム/選手ページ、会場地図、スポンサー掲出。
* 検索/フィルタ、SNSシェア、OGP最適化、YouTube埋め込み対応。

---

以降のデータモデル、機能要件、非機能要件、API設計、リリース計画は既存定義に加え、**本UI仕様**を実装対象に含める。
